#!/usr/bin/env python3

import rospy
import cv2
import numpy as np

from sensor_msgs.msg import Image
from cv_bridge import CvBridge

from ultralytics import YOLO


class YoloSegNode:
    def __init__(self):
        rospy.init_node("yolo_cube_seg_node")

        self.bridge = CvBridge()

        # Load YOLO model ONCE
        model_path = rospy.get_param("~model_path", "yolov8n-seg.pt")
        self.target_class = rospy.get_param("~target_class", "cup")

        rospy.loginfo(f"Loading YOLO model: {model_path}")
        self.model = YOLO(model_path)

        # Subscribe to RGB image
        self.image_sub = rospy.Subscriber(
            "/sciurus17/camera/color/image_raw",
            Image,
            self.image_callback,
            queue_size=1
        )

        rospy.loginfo("YOLO segmentation node started")

    def image_callback(self, msg):
        # Convert ROS â†’ OpenCV
        img = self.bridge.imgmsg_to_cv2(msg, desired_encoding="bgr8")

        # Run YOLO
        results = self.model(img, conf=0.5, verbose=False)

        for r in results:
            if r.masks is None:
                continue

            for i, cls_id in enumerate(r.boxes.cls):
                class_name = self.model.names[int(cls_id)]

                if class_name != self.target_class:
                    continue

                mask = r.masks.data[i].cpu().numpy().astype(bool)

                # Visualization overlay
                overlay = img.copy()
                overlay[mask] = (0, 255, 0)
                vis = cv2.addWeighted(img, 0.7, overlay, 0.3, 0)

                cv2.imshow("YOLO Cube Segmentation", vis)
                cv2.waitKey(1)

                # For now: handle only one cube
                return


if __name__ == "__main__":
    try:
        YoloSegNode()
        rospy.spin()
    except rospy.ROSInterruptException:
        pass
